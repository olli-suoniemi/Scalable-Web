import { readReply } from "./reply.ts";
import { ErrorReplyError } from "../errors.ts";
import { encoder } from "./_util.ts";
const CRLF = encoder.encode("\r\n");
const ArrayCode = encoder.encode("*");
const BulkCode = encoder.encode("$");
const kEmptyBuffer = new Uint8Array(0);
async function writeRequest(writer, command, args) {
  const request = encodeRequest(command, args);
  await writer.write(request);
}
function encodeRequest(command, args) {
  const encodedArgsCount = encoder.encode(String(1 + args.length));
  const encodedCommand = encoder.encode(command);
  const encodedCommandLength = encoder.encode(String(encodedCommand.byteLength));
  let totalBytes = ArrayCode.byteLength + encodedArgsCount.byteLength + CRLF.byteLength + BulkCode.byteLength + encodedCommandLength.byteLength + CRLF.byteLength + encodedCommand.byteLength + CRLF.byteLength;
  const encodedArgs = Array(args.length);
  for(let i = 0; i < args.length; i++){
    const arg = args[i];
    const bytes = arg instanceof Uint8Array ? arg : arg == null ? kEmptyBuffer : encoder.encode(String(arg));
    const bytesLen = bytes.byteLength;
    totalBytes += BulkCode.byteLength + String(bytesLen).length + CRLF.byteLength + bytes.byteLength + CRLF.byteLength;
    encodedArgs[i] = bytes;
  }
  const request = new Uint8Array(totalBytes);
  let index = 0;
  index = writeFrom(request, ArrayCode, index);
  index = writeFrom(request, encodedArgsCount, index);
  index = writeFrom(request, CRLF, index);
  index = writeFrom(request, BulkCode, index);
  index = writeFrom(request, encodedCommandLength, index);
  index = writeFrom(request, CRLF, index);
  index = writeFrom(request, encodedCommand, index);
  index = writeFrom(request, CRLF, index);
  for(let i = 0; i < encodedArgs.length; i++){
    const encodedArg = encodedArgs[i];
    const encodedArgLength = encoder.encode(String(encodedArg.byteLength));
    index = writeFrom(request, BulkCode, index);
    index = writeFrom(request, encodedArgLength, index);
    index = writeFrom(request, CRLF, index);
    index = writeFrom(request, encodedArg, index);
    index = writeFrom(request, CRLF, index);
  }
  return request;
}
function writeFrom(bytes, payload, fromIndex) {
  bytes.set(payload, fromIndex);
  return fromIndex + payload.byteLength;
}
export async function sendCommand(writer, reader, command, args, returnUint8Arrays) {
  await writeRequest(writer, command, args);
  await writer.flush();
  return readReply(reader, returnUint8Arrays);
}
export async function sendCommands(writer, reader, commands) {
  for (const { command, args } of commands){
    await writeRequest(writer, command, args);
  }
  await writer.flush();
  const ret = [];
  for(let i = 0; i < commands.length; i++){
    try {
      const rep = await readReply(reader, commands[i].returnUint8Arrays);
      ret.push(rep);
    } catch (e) {
      if (e instanceof ErrorReplyError) {
        ret.push(e);
      } else {
        throw e;
      }
    }
  }
  return ret;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0dHBzOi8vZGVuby5sYW5kL3gvcmVkaXNAdjAuMzEuMC9wcm90b2NvbC9jb21tYW5kLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJ1ZlJlYWRlciB9IGZyb20gXCIuLi92ZW5kb3IvaHR0cHMvZGVuby5sYW5kL3N0ZC9pby9idWZfcmVhZGVyLnRzXCI7XG5pbXBvcnQgeyBCdWZXcml0ZXIgfSBmcm9tIFwiLi4vdmVuZG9yL2h0dHBzL2Rlbm8ubGFuZC9zdGQvaW8vYnVmX3dyaXRlci50c1wiO1xuaW1wb3J0IHsgcmVhZFJlcGx5IH0gZnJvbSBcIi4vcmVwbHkudHNcIjtcbmltcG9ydCB7IEVycm9yUmVwbHlFcnJvciB9IGZyb20gXCIuLi9lcnJvcnMudHNcIjtcbmltcG9ydCB7IGVuY29kZXIgfSBmcm9tIFwiLi9fdXRpbC50c1wiO1xuaW1wb3J0IHR5cGUgeyBSZWRpc1JlcGx5LCBSZWRpc1ZhbHVlIH0gZnJvbSBcIi4vdHlwZXMudHNcIjtcblxuY29uc3QgQ1JMRiA9IGVuY29kZXIuZW5jb2RlKFwiXFxyXFxuXCIpO1xuY29uc3QgQXJyYXlDb2RlID0gZW5jb2Rlci5lbmNvZGUoXCIqXCIpO1xuY29uc3QgQnVsa0NvZGUgPSBlbmNvZGVyLmVuY29kZShcIiRcIik7XG5cbmNvbnN0IGtFbXB0eUJ1ZmZlciA9IG5ldyBVaW50OEFycmF5KDApO1xuXG5hc3luYyBmdW5jdGlvbiB3cml0ZVJlcXVlc3QoXG4gIHdyaXRlcjogQnVmV3JpdGVyLFxuICBjb21tYW5kOiBzdHJpbmcsXG4gIGFyZ3M6IFJlZGlzVmFsdWVbXSxcbikge1xuICBjb25zdCByZXF1ZXN0ID0gZW5jb2RlUmVxdWVzdChjb21tYW5kLCBhcmdzKTtcbiAgYXdhaXQgd3JpdGVyLndyaXRlKHJlcXVlc3QpO1xufVxuXG5mdW5jdGlvbiBlbmNvZGVSZXF1ZXN0KFxuICBjb21tYW5kOiBzdHJpbmcsXG4gIGFyZ3M6IFJlZGlzVmFsdWVbXSxcbik6IFVpbnQ4QXJyYXkge1xuICBjb25zdCBlbmNvZGVkQXJnc0NvdW50ID0gZW5jb2Rlci5lbmNvZGUoXG4gICAgU3RyaW5nKDEgKyBhcmdzLmxlbmd0aCksXG4gICk7XG4gIGNvbnN0IGVuY29kZWRDb21tYW5kID0gZW5jb2Rlci5lbmNvZGUoY29tbWFuZCk7XG4gIGNvbnN0IGVuY29kZWRDb21tYW5kTGVuZ3RoID0gZW5jb2Rlci5lbmNvZGUoXG4gICAgU3RyaW5nKGVuY29kZWRDb21tYW5kLmJ5dGVMZW5ndGgpLFxuICApO1xuICBsZXQgdG90YWxCeXRlcyA9IEFycmF5Q29kZS5ieXRlTGVuZ3RoICtcbiAgICBlbmNvZGVkQXJnc0NvdW50LmJ5dGVMZW5ndGggK1xuICAgIENSTEYuYnl0ZUxlbmd0aCArXG4gICAgQnVsa0NvZGUuYnl0ZUxlbmd0aCArXG4gICAgZW5jb2RlZENvbW1hbmRMZW5ndGguYnl0ZUxlbmd0aCArXG4gICAgQ1JMRi5ieXRlTGVuZ3RoICtcbiAgICBlbmNvZGVkQ29tbWFuZC5ieXRlTGVuZ3RoICtcbiAgICBDUkxGLmJ5dGVMZW5ndGg7XG4gIGNvbnN0IGVuY29kZWRBcmdzOiBBcnJheTxVaW50OEFycmF5PiA9IEFycmF5KGFyZ3MubGVuZ3RoKTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgaSsrKSB7XG4gICAgY29uc3QgYXJnID0gYXJnc1tpXTtcbiAgICBjb25zdCBieXRlcyA9IGFyZyBpbnN0YW5jZW9mIFVpbnQ4QXJyYXlcbiAgICAgID8gYXJnXG4gICAgICA6IChhcmcgPT0gbnVsbCA/IGtFbXB0eUJ1ZmZlciA6IGVuY29kZXIuZW5jb2RlKFN0cmluZyhhcmcpKSk7XG4gICAgY29uc3QgYnl0ZXNMZW4gPSBieXRlcy5ieXRlTGVuZ3RoO1xuICAgIHRvdGFsQnl0ZXMgKz0gQnVsa0NvZGUuYnl0ZUxlbmd0aCArXG4gICAgICBTdHJpbmcoYnl0ZXNMZW4pLmxlbmd0aCArXG4gICAgICBDUkxGLmJ5dGVMZW5ndGggK1xuICAgICAgYnl0ZXMuYnl0ZUxlbmd0aCArXG4gICAgICBDUkxGLmJ5dGVMZW5ndGg7XG4gICAgZW5jb2RlZEFyZ3NbaV0gPSBieXRlcztcbiAgfVxuXG4gIGNvbnN0IHJlcXVlc3QgPSBuZXcgVWludDhBcnJheSh0b3RhbEJ5dGVzKTtcbiAgbGV0IGluZGV4ID0gMDtcbiAgaW5kZXggPSB3cml0ZUZyb20ocmVxdWVzdCwgQXJyYXlDb2RlLCBpbmRleCk7XG4gIGluZGV4ID0gd3JpdGVGcm9tKHJlcXVlc3QsIGVuY29kZWRBcmdzQ291bnQsIGluZGV4KTtcbiAgaW5kZXggPSB3cml0ZUZyb20ocmVxdWVzdCwgQ1JMRiwgaW5kZXgpO1xuICBpbmRleCA9IHdyaXRlRnJvbShyZXF1ZXN0LCBCdWxrQ29kZSwgaW5kZXgpO1xuICBpbmRleCA9IHdyaXRlRnJvbShyZXF1ZXN0LCBlbmNvZGVkQ29tbWFuZExlbmd0aCwgaW5kZXgpO1xuICBpbmRleCA9IHdyaXRlRnJvbShyZXF1ZXN0LCBDUkxGLCBpbmRleCk7XG4gIGluZGV4ID0gd3JpdGVGcm9tKHJlcXVlc3QsIGVuY29kZWRDb21tYW5kLCBpbmRleCk7XG4gIGluZGV4ID0gd3JpdGVGcm9tKHJlcXVlc3QsIENSTEYsIGluZGV4KTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBlbmNvZGVkQXJncy5sZW5ndGg7IGkrKykge1xuICAgIGNvbnN0IGVuY29kZWRBcmcgPSBlbmNvZGVkQXJnc1tpXTtcbiAgICBjb25zdCBlbmNvZGVkQXJnTGVuZ3RoID0gZW5jb2Rlci5lbmNvZGUoU3RyaW5nKGVuY29kZWRBcmcuYnl0ZUxlbmd0aCkpO1xuICAgIGluZGV4ID0gd3JpdGVGcm9tKHJlcXVlc3QsIEJ1bGtDb2RlLCBpbmRleCk7XG4gICAgaW5kZXggPSB3cml0ZUZyb20ocmVxdWVzdCwgZW5jb2RlZEFyZ0xlbmd0aCwgaW5kZXgpO1xuICAgIGluZGV4ID0gd3JpdGVGcm9tKHJlcXVlc3QsIENSTEYsIGluZGV4KTtcbiAgICBpbmRleCA9IHdyaXRlRnJvbShyZXF1ZXN0LCBlbmNvZGVkQXJnLCBpbmRleCk7XG4gICAgaW5kZXggPSB3cml0ZUZyb20ocmVxdWVzdCwgQ1JMRiwgaW5kZXgpO1xuICB9XG5cbiAgcmV0dXJuIHJlcXVlc3Q7XG59XG5cbmZ1bmN0aW9uIHdyaXRlRnJvbShcbiAgYnl0ZXM6IFVpbnQ4QXJyYXksXG4gIHBheWxvYWQ6IFVpbnQ4QXJyYXksXG4gIGZyb21JbmRleDogbnVtYmVyLFxuKTogbnVtYmVyIHtcbiAgYnl0ZXMuc2V0KHBheWxvYWQsIGZyb21JbmRleCk7XG4gIHJldHVybiBmcm9tSW5kZXggKyBwYXlsb2FkLmJ5dGVMZW5ndGg7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzZW5kQ29tbWFuZChcbiAgd3JpdGVyOiBCdWZXcml0ZXIsXG4gIHJlYWRlcjogQnVmUmVhZGVyLFxuICBjb21tYW5kOiBzdHJpbmcsXG4gIGFyZ3M6IFJlZGlzVmFsdWVbXSxcbiAgcmV0dXJuVWludDhBcnJheXM/OiBib29sZWFuLFxuKTogUHJvbWlzZTxSZWRpc1JlcGx5PiB7XG4gIGF3YWl0IHdyaXRlUmVxdWVzdCh3cml0ZXIsIGNvbW1hbmQsIGFyZ3MpO1xuICBhd2FpdCB3cml0ZXIuZmx1c2goKTtcbiAgcmV0dXJuIHJlYWRSZXBseShyZWFkZXIsIHJldHVyblVpbnQ4QXJyYXlzKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNlbmRDb21tYW5kcyhcbiAgd3JpdGVyOiBCdWZXcml0ZXIsXG4gIHJlYWRlcjogQnVmUmVhZGVyLFxuICBjb21tYW5kczoge1xuICAgIGNvbW1hbmQ6IHN0cmluZztcbiAgICBhcmdzOiBSZWRpc1ZhbHVlW107XG4gICAgcmV0dXJuVWludDhBcnJheXM/OiBib29sZWFuO1xuICB9W10sXG4pOiBQcm9taXNlPHVua25vd25bXT4ge1xuICBmb3IgKGNvbnN0IHsgY29tbWFuZCwgYXJncyB9IG9mIGNvbW1hbmRzKSB7XG4gICAgYXdhaXQgd3JpdGVSZXF1ZXN0KHdyaXRlciwgY29tbWFuZCwgYXJncyk7XG4gIH1cbiAgYXdhaXQgd3JpdGVyLmZsdXNoKCk7XG4gIGNvbnN0IHJldDogdW5rbm93bltdID0gW107XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgY29tbWFuZHMubGVuZ3RoOyBpKyspIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVwID0gYXdhaXQgcmVhZFJlcGx5KHJlYWRlciwgY29tbWFuZHNbaV0ucmV0dXJuVWludDhBcnJheXMpO1xuICAgICAgcmV0LnB1c2gocmVwKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBpZiAoZSBpbnN0YW5jZW9mIEVycm9yUmVwbHlFcnJvcikge1xuICAgICAgICByZXQucHVzaChlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IGU7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHJldHVybiByZXQ7XG59XG4iXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsU0FBUyxTQUFTLFFBQVEsYUFBYTtBQUN2QyxTQUFTLGVBQWUsUUFBUSxlQUFlO0FBQy9DLFNBQVMsT0FBTyxRQUFRLGFBQWE7QUFHckMsTUFBTSxPQUFPLFFBQVEsTUFBTSxDQUFDO0FBQzVCLE1BQU0sWUFBWSxRQUFRLE1BQU0sQ0FBQztBQUNqQyxNQUFNLFdBQVcsUUFBUSxNQUFNLENBQUM7QUFFaEMsTUFBTSxlQUFlLElBQUksV0FBVztBQUVwQyxlQUFlLGFBQ2IsTUFBaUIsRUFDakIsT0FBZSxFQUNmLElBQWtCO0VBRWxCLE1BQU0sVUFBVSxjQUFjLFNBQVM7RUFDdkMsTUFBTSxPQUFPLEtBQUssQ0FBQztBQUNyQjtBQUVBLFNBQVMsY0FDUCxPQUFlLEVBQ2YsSUFBa0I7RUFFbEIsTUFBTSxtQkFBbUIsUUFBUSxNQUFNLENBQ3JDLE9BQU8sSUFBSSxLQUFLLE1BQU07RUFFeEIsTUFBTSxpQkFBaUIsUUFBUSxNQUFNLENBQUM7RUFDdEMsTUFBTSx1QkFBdUIsUUFBUSxNQUFNLENBQ3pDLE9BQU8sZUFBZSxVQUFVO0VBRWxDLElBQUksYUFBYSxVQUFVLFVBQVUsR0FDbkMsaUJBQWlCLFVBQVUsR0FDM0IsS0FBSyxVQUFVLEdBQ2YsU0FBUyxVQUFVLEdBQ25C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